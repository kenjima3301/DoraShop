name: Trigger DevOps Update

on:
  push:
    branches: [ "main" ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changed Paths
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            cart:
              - cart/**
            products:
              - products/**
            core:
              - dorashop/**
              - requirements.txt
              - Dockerfile
              - docker-compose.yml
              - manage.py
              - entrypoint.sh

      - name: Build Changed Paths
        id: paths
        run: |
          PATHS=""
          
          if [[ "${{ steps.changed-files.outputs.cart_any_changed }}" == "true" ]]; then
            PATHS="${PATHS}cart "
          fi
          
          if [[ "${{ steps.changed-files.outputs.products_any_changed }}" == "true" ]]; then
            PATHS="${PATHS}products "
          fi
          
          if [[ "${{ steps.changed-files.outputs.core_any_changed }}" == "true" ]]; then
            PATHS="${PATHS}core "
          fi
          
          # Trim spaces
          PATHS=$(echo "$PATHS" | xargs)
          
          # If empty, set to "other"
          if [[ -z "$PATHS" ]]; then
            PATHS="other"
          fi
          
          echo "changed=$PATHS" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changed: $PATHS"

      - name: Send Dispatch Event
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.DEVOPS_PAT }}
          repository: kenjima3301/NT548-DevOps 
          event-type: update-submodule
          client-payload: '{"sha": "${{ github.sha }}", "paths": "${{ steps.paths.outputs.changed }}"}'